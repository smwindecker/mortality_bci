packages:
  - RCurl
  - downloader
  - rmarkdown
  - dplyr
  - tidyr
  - rstan
  - callr
  - dockertest
  - knitr
  - ggplot2
  - cowplot

sources:
  - R
  
plot_options:

  portrait_png:
    width: 750
    height: 900
    
  single_col_tall_rectangle:
    width: 3.46
    height: 8

targets:
  all:
    depends:
      - precompile/kfold_data/bci_data.rds
      - precompile/bci_data_full.rds
      - ms/figures/plot_obs_v_pred_growth.png
      
  process_crossval:
    depends:
      - func_growth_diagnostics
      - logloss_func_growth
      - random_effect_diagnostics
      - logloss_re_comparison
      - rho_comparisons_diagnostics
      - logloss_rho_comparisons
      - ms/figures/fig1.pdf
      
  #------------- download data ---------------------------
  downloads/bci.spptable.rdata:
    command: BCI_download_species_table(target_name)
    cleanup_level: never
    check: exists
    
  downloads/bci.full.Rdata31Aug2012.zip:
    command: BCI_download_50ha_plot_full(target_name)
    cleanup_level: never
    check: exists

  #------------- Load data  -------------------------------
  
  BCI_50haplot:
    command: BCI_load_50ha_plot("downloads/bci.full.Rdata31Aug2012.zip")
    cleanup_level: purge
    
  BCI_traits:
    command: load_trait_data("data/BCI_traits_20101220.csv")
    cleanup_level: purge

  BCI_nomenclature:
    command: BCI_load_nomenclature("downloads/bci.spptable.rdata")
    cleanup_level: purge
    
  BCI_dbh_error_data:
    command: BCI_load_dbh_error_data("data/dbh_error_data.rdata")
    cleanup_level: purge
  
  #------------- Process data  ----------------------------
  
  BCI_cleaned:
    command: BCI_clean(BCI_50haplot, BCI_nomenclature)
    cleanup_level: purge

  BCI_model_dataset_full:
    command: merge_BCI_data(BCI_cleaned, BCI_traits)
    cleanup_level: purge
    
  BCI_model_dataset_unique:
    command: reduce_to_single_ind_obs(BCI_model_dataset_full)
    cleanup_level: purge
    
  BCI_model_dataset_true_unique:
    command: add_true_growth(BCI_model_dataset_unique, BCI_true_dbh_model)
    cleanup_level: purge
    
  BCI_model_dataset_folds:
    command: split_into_kfolds(BCI_model_dataset_true_unique)
    cleanup_level: purge
    
  BCI_training_full:
    command: extract_trainheldout_set(BCI_model_dataset_folds, NA)
    cleanup_level: purge
    
  BCI_training_sets:
    command: make_trainheldout(BCI_model_dataset_folds)
    cleanup_level: purge

  #------------- data export ---------------------------

  precompile/kfold_data/bci_data.rds:
    command: export_data(BCI_training_sets, target_name)
    cleanup_level: purge

  precompile/bci_data_full.rds:
    command: saveRDS(BCI_training_full, target_name)
    cleanup_level: purge


  #------------- Models ---------------------------
  BCI_true_dbh_model:
    command: run_true_dbh_model(BCI_model_dataset_unique)
    cleanup_level: purge
    check: exists  

  crossval_models_precompiled_docker:
    command: precompile_docker(I("traitecoevo/mortality_bci"))
    cleanup_level: purge
    
  fulldata_models_precompiled_docker:
    command: precompile_docker(I("traitecoevo/mortality_bci"), FALSE)
    cleanup_level: purge
    
  #------------- Process outputs -------------------
  
  # function and growth comparison
  func_growth_diagnostics:
    command: model_diagnostics(I("function_growth_comparison"))
    cleanup_level: tidy

  logloss_func_growth:
    command: summarise_crossval_logloss(I("function_growth_comparison"))
    cleanup_level: tidy
    
  # Random effect & non random effect comparison
  random_effect_diagnostics:
    command: model_diagnostics(I("species_random_effects"))
    cleanup_level: tidy
    
  logloss_re_comparison:
    command: summarise_crossval_logloss(I("species_random_effects"))
    cleanup_level: tidy
    
  # Rho combinations
  rho_comparisons_diagnostics:
    command: model_diagnostics(I("rho_combinations"))
    cleanup_level: tidy
    
  logloss_rho_comparisons:
    command: summarise_crossval_logloss(I("rho_combinations"))
    cleanup_level: tidy
  #------------- Figures ---------------------------
  figures/plot_obs_v_pred_growth.png:
    command: plot_obs_v_pred_growth(BCI_model_dataset_true_unique)
    plot: portrait_png
    cleanup_level: tidy
    
  ms/figures/fig1.pdf:
    command: plot_fig1(logloss_func_growth,logloss_re_comparison,logloss_rho_comparisons)
    plot: single_col_tall_rectangle
    cleanup_level: tidy
  #------------- Manuscript ---------------------------

  ms/ms.tex:
    depends:
      - BCI_model_dataset_true_unique
      - BCI_dbh_error_data
      - BCI_training_sets
    knitr: TRUE

  ms/ms.pdf:
    command: latex_build("ms/ms.tex", "ms/refs.bib", clean=TRUE)
    depends:
      - ms/pnas-new.cls
      - ms/pnasresearcharticle.sty
      - ms/widetext.sty
      - ms/figures/fig1.pdf
