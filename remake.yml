packages:
  - RCurl
  - downloader
  - rmarkdown
  - dplyr
  - rstan

sources:
  - R

targets:
  all:
    depends:
      - export_1

  export_1:
    depends:
      - export/bci_data.rds
      - export/bci_data_full.rds
      - figure/plot_obs_v_pred

  # Watch out; this one is a bit evil; it also creates sub filenames:
  #   export/bci_data_1.rds ... export_bci_data_10.rds
  export/bci_data.rds:
    command: export_data(BCI_training_sets, target_name)

  BCI_training_sets:
    command: make_trainheldout(BCI_model_dataset_folds)
    cleanup_level: purge

  export/bci_data_full.rds:
    command: saveRDS(BCI_training_full, target_name)

  BCI_training_full:
    command: extract_trainheldout_set(BCI_model_dataset_folds, NA)
    cleanup_level: purge

  BCI_model_dataset_folds:
    command: split_into_kfolds(BCI_model_dataset_true_unique)
    cleanup_level: purge
    
  figure/plot_obs_v_pred:
    command: plot_obs_v_pred_growth(BCI_model_dataset_true_unique)
    cleanup_level: purge
    check: exists


  BCI_model_dataset_true_unique:
    command: add_true_growth(BCI_model_dataset_unique, BCI_true_dbh_model)
    cleanup_level: purge

  BCI_true_dbh_model:
    command: run_true_dbh_model(BCI_model_dataset_unique, BCI_dbh_error_model)
    cleanup_level: never
    check: exists

  BCI_dbh_error_model:
    command: run_dbh_error_model(BCI_dbh_error_data)
    cleanup_level: never
    check: exists

  BCI_dbh_error_data:
    command: BCI_load_dbh_error_data("data/dbh_error_data.rdata")
    cleanup_level: purge

  BCI_model_dataset_unique:
    command: reduce_to_single_ind_obs(BCI_model_dataset_full)
    cleanup_level: purge

  BCI_model_dataset_full:
    command: merge_BCI_data(BCI_cleaned, BCI_traits)
    cleanup_level: purge

  BCI_cleaned:
    command: BCI_clean(BCI_50haplot, BCI_nomenclature)
    cleanup_level: purge

  BCI_traits:
    command: load_trait_data("data/BCI_traits_20101220.csv")
    cleanup_level: purge

  BCI_50haplot:
    command: BCI_load_50ha_plot("downloads/bci.full.Rdata31Aug2012.zip")
    cleanup_level: purge

  downloads/bci.full.Rdata31Aug2012.zip:
    command: BCI_download_50ha_plot_full(target_name)
    cleanup_level: never
    check: exists

  BCI_nomenclature:
    command: BCI_load_nomenclature("downloads/bci.spptable.rdata")

  downloads/bci.spptable.rdata:
    command: BCI_download_species_table(target_name)
    cleanup_level: never
    check: exists

  # paper
  downloads/style.csl:
    command: get_amnat_csl(target_name)

  ms.pdf:
    command: pandoc_build("ms.md")

  ms.md:
    knitr: true
    depends:
      - data/refs.bib
      - downloads/style.csl
