packages:
  - dplyr
  - rstan
  - RCurl
  - downloader
  - rmarkdown

sources:
  - R

targets:
  all:
    depends:
      - ms.md

  stan_output_combined:
    command: combine_stan_chains(chain1_model3_trait_species)

  fits:
    depends:
      - chain1_model1_species
      - chain1_model1_trait_species
      - chain1_model2_species
      - chain1_model2_trait_species
      - chain1_model3_constant
      - chain1_model3_trait
      - chain1_model3_species
      - chain1_model3_trait_species

  # Model 3 ----------------------------------------------------------
  ## constant effects
  chain1_model3_constant:
    command: run_single_stan_chain(stan_model3_constant, stan_data, chain_id=I(1), iter=I(10))

  stan_model3_constant:
    command: make_stan_model(chunks_model3_constant)

  chunks_model3_constant:
    command: get_chunks_model3_constant()

  ## trait effects
  chain1_model3_trait:
    command: run_single_stan_chain(stan_model3_trait, stan_data, chain_id=I(1), iter=I(10))

  stan_model3_trait:
    command: make_stan_model(chunks_model3_trait)

  chunks_model3_trait:
    command: get_chunks_model3_trait()

  ## species effects
  chain1_model3_species:
    command: run_single_stan_chain(stan_model3_species, stan_data, chain_id=I(1), iter=I(10))

  stan_model3_species:
    command: make_stan_model(chunks_model3_species)

  chunks_model3_species:
    command: get_chunks_model3_species()

  ## species + trait effects
  chain1_model3_trait_species:
    command: run_single_stan_chain(stan_model3_trait_species, stan_data, chain_id=I(1), iter=I(10))

  stan_model3_trait_species:
    command: make_stan_model(chunks_model3_trait_species)

  chunks_model3_trait_species:
    command: get_chunks_model3_trait_species()

  # Model 2 ----------------------------------------------------------
  chain1_model2_species:
    command: run_single_stan_chain(stan_model2_species, stan_data, chain_id=I(1), iter=I(10))

  stan_model2_species:
    command: make_stan_model(chunks_model2_species)

  chunks_model2_species:
    command: get_chunks_model2_species()

  chain1_model2_trait_species:
    command: run_single_stan_chain(stan_model2_trait_species, stan_data, chain_id=I(1), iter=I(10))

  stan_model2_trait_species:
    command: make_stan_model(chunks_model2_trait_species)

  chunks_model2_trait_species:
    command: get_chunks_model2_trait_species()

  # Model 1 ----------------------------------------------------------
  chain1_model1_species:
    command: run_single_stan_chain(stan_model1_species, stan_data, chain_id=I(1), iter=I(10))

  stan_model1_species:
    command: make_stan_model(chunks_model1_species)

  chunks_model1_species:
    command: get_chunks_model1_species()


  chain1_model1_trait_species:
    command: run_single_stan_chain(stan_model1_trait_species, stan_data, chain_id=I(1), iter=I(10))

  stan_model1_trait_species:
    command: make_stan_model(chunks_model1_trait_species)

  chunks_model1_trait_species:
    command: get_chunks_model1_trait_species()

  # data preparation
  stan_data:
    command: stan_data_BCI(BCI_model_dataset_census4)

  BCI_model_dataset_census4:
    command: subset_BCI_data_by_census(BCI_model_dataset_full, census=I(4))

  BCI_model_dataset_full:
    command: merge_BCI_data(BCI_demography, BCI_traits)

  BCI_demography:
    command: BCI_calculate_individual_growth(BCI_50haplot, BCI_nomenclature)

  BCI_traits:
    command: load_trait_data("data/BCI_traits_20101220.csv")

  BCI_50haplot:
    command: BCI_load_50ha_plot("downloads/bci.full.Rdata31Aug2012.zip")

  downloads/bci.full.Rdata31Aug2012.zip:
    command: BCI_download_50ha_plot_full(target_name)
    cleanup_level: never
    check: exists

  BCI_nomenclature:
    command: BCI_load_nomenclature("downloads/bci.spptable.rdata")

  downloads/bci.spptable.rdata:
    command: BCI_download_species_table(target_name)
    cleanup_level: never
    check: exists

  # paper
  downloads/style.csl:
    command: get_amnat_csl(target_name)

  ms.pdf:
    command: pandoc_build("ms.md")

  ms.md:
    knitr: true
    depends:
      - stan_output_combined
      - stan_data
      - data/refs.bib
      - downloads/style.csl
