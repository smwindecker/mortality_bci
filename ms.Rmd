---
title: "Wood density and the growth-dependent & independent mortality"
author: "J S Camac"
date: "30 Mar 2015"
output: pdf_document
csl: downloads/style.csl
bibliography: data/refs.bib
---

##Introduction
Understanding who lives or dies, and why, is critical to accurately predict population, community and ecosystem dynamics [@Hawkes:2000ib; @McDowell:2011dr]. In plants, the carbon budget is considered a fundamental determinant of mortality, such that if rates of carbon assimilation are low or become insufficient for growth, an individual is more likely to die [@Peet:1987va; @Hawkes:2000ib; @Keane:2001db; @McDowell:2011dr]. Empirical studies have broadly supported this assumption, with many studies showing that the probability of dying decreasing exponentially with growth rate [Fig 1; @Buchman:1983vx; @Kobe:1997vy; @Wyckoff:2002ul; @Mantgem:2003dw], and consequently most dynamic vegetation models, including tree gap models [@Botkin:1972ii; @Keane:2001db] and Dynamic Global Vegetation Models (DGVM's; @Woodward:2004ft) use this growth-mortality relationship as the predominant, and in many cases, only cause of plant mortality [@Hawkes:2000ib; @McDowell:2011dr].

<!-- ![Fig1](figures/wyckoff2002.png) -->

**Fig 1:** The relationship between growth and mortality for seven co-occurring tree species in the southern Appalachian Mountains. From @Wyckoff:2002ul.


However, empirical evidence has highlighted that this growth-mortality relationship varies between species with those that grow intrinsically faster exhibiting higher mortality rates relative to those which are slower growing (Fig 2; @Poorter:2008iu; @Wright:2010fl). Plant functional traits – attributes of species that influence vital rates (i.e. survival, growth and reproduction) and ultimately fitness [@Ackerly:2003eb; @Poorter:2008iu] – have been used to examine this inter-specific variability.

<!-- ![Fig2](figures/wright2010.jpg) -->

**Fig 2:** The growth–mortality trade-off for saplings expressed as the 95th percentile relative growth rate (RGR95) vs. the mortality rate of the slowest growing 25% of individuals (M25) for 103 tree species on Barro Colorado Island, Panama. From @Wright:2010fl.

In tropical rain forests, wood density, the biomass invested per unit wood volume, is one such functional trait that has been repeatedly identified as being negatively correlated with tree mortality [Fig. 3; @Nascimento:2005wx; @King:2006he; @AlvarezClare:2007gv; @Chao:2008hg; @Poorter:2008iu; @Kraft:2010kq; @Wright:2010fl]. This relationship is thought to be due to dense wood conveying enhanced physical resistance to growth-independent causes (Fig 4) of mortality such as stem breakage [@Putz:1983wu; @vanGelder:2006ex; @Chave:2009iy], wood herbivory (NEED REF), embolism [@Hacke:2001kj, @Jacobsen:2005fx, @Preston:2006jn] and fungal and pathogen attack [@Augspurger:1984wx]. However, wood density may also increase survival associated with growth-dependent mortality. For example, studies [e.g. @vanGelder:2006ex] have highlighted that species with high wood density are often more shade tolerant, and thus exhibit a lower probability of dying at low growth rates. Studies have also shown that wood density may reduce drought induced carbon starvation [@McDowell:2011dr] and the susceptibility of ‘stressed’ individuals to opportunistic invertebrate, pathogen or fungal attack [@Augspurger:1984wx; @McDowell:2011dr].

<!-- ![Fig3](figures/kraft2010.png) -->

**Fig 3:** The relationship between wood density and mortality in a global tropical forest dataset. From @Kraft:2010kq


<!-- ![Fig4](figures/chave2009.png) -->

**Fig 4:** Wood mechanical traits plotted against wood density. From @Chave:2009iy

\pagebreak

In this study we build a hierarchical Bayesian logistic regression that attempts to partitions 15-years of tropical tree mortality into growth-dependent and growth-independent hazards (i.e. death not related to growth). We then use this model to address three questions: 1) Does wood density affect the growth-mortality relationship? 2) Where does wood density have the greatest effect growth-dependent or growth-independent hazards? And 3) Do the observed relationships dependent on the choice of growth measure?

We hypothesize that wood density will decrease both growth-dependent and growth-independent sources of mortality. Specifically, we expect wood density to affect the growth-mortality relationship by decreasing its intercept, (i.e. mortality rates at zero growth) and steepening its slope (i.e. more negative, Fig 5). We also expect that the effect of wood density will be greatest for growth-independent mortality, and that these relationships will be broadly consistent across growth measures.

```{r hypotheses,fig.height=6,fig.width=6, echo=FALSE}
par(mfrow=c(2,1), mar=c(2,4,1,1), oma=c(3,0,0,0), xaxs='i')
curve(exp(1 -exp(-0.3) * x) + exp(-2), xlim=c(0,12), ylim=c(0,5),
xlab=NA, ylab='Hazard rate', xaxt='n')
curve(exp(0.5 -exp(1) * x) + exp(-4), add=TRUE, col='red')
axis(1, at=0)

legend('topright', c('low rho', 'high rho'), col=c('black','red'), lty=1, bty='n')
curve((1-exp(-(exp(1 - exp(-0.3) * x) + exp(-1.5))))*100, xlim=c(0,12), ylim=c(0,100),
xlab=NA, ylab='Pr(Mortality)/year', xaxt='n')
curve((1-exp(-(exp(0.5 - exp(1) * x) + exp(-4))))*100, add=TRUE, col='red')
abline(v=0, lty=2, col='blue')
axis(1, at=0)
mtext(side=1, 'Growth rate',line = 1, outer=TRUE)

```

**Fig 5:** Hypotheses of how wood density will affect growth-mortality curve. Top = Hazard curves (i.e. instantaneous mortality rates); Bottom = Mortality probability/year based on estimated hazard rates. Where curve asymptotes is dependent on wood density effects on growth-independent hazard. Note changes in intercept, slope and asymptote between both lines.

\pagebreak

##Data

We are fitting our model to growth and mortality data collected from a tropical rainforest on Barro Colorado Island, Panama @BarroColoradofores:2012up. This rainforest plot has been surveyed every 5 years since 1985 and includes size, growth and status (alive, dead) observations from more than 200,000 individuals across 286 species.

In this study we only use data recorded between 1990 and 2010 for single stemmed plants. Furthermore, we only used species that had an estimate for wood density. We removed multistemmed plants because of difficulties discerning mainstem.

For more details about the data, or to download it, please click [here](https://repository.si.edu/handle/10088/20925).
Currently species trait data is not publically available.

##Model Description

We used a hierarchical generalized linear model to examine how wood density affected growth-dependent and growth-independent tree mortality. These models are well suited to data sets that have a hierarchical structure (e.g. individuals within species) because they can account for observation error and partition both explained and unexplained variation at multiple levels of a dataset [@Gelman:2007te; @Kery:2010tp]. We used Bayesian inference and fitted models to data using Markov chain Monte Carlo (MCMC) sampling in R 3.1.3 using package rstan version 2.6 [@StanDevelopmentTeam:2015uz]. Before commencing model fit, we first scaled growth by dividing by two standard deviations. We then centered and scaled wood density, $rho$, by first log-transforming it and then substracting its mean and dividing by two standard deviations. The advantage of centering and standardizing is that it allows for better mixing of chains and easier interpretation, with intercepts interpreted as average responses and slope terms as partial dependencies conditional on other continuous variables at their mean. Furthermore, standardizing by two standard deviations allows the magnitude of effects to be directly compared between binary and continuous covariates (Gelman and Hill 2007). Three independent chains were executed and in all cases modeled parameters converged within 1000 iterations. Convergence was assessed through both visual inspection of chains and reference to the Brooks-Gelman-Rubin convergence diagnostic [@Gelman:1992ts; @Brooks:1998ju]. After discarding the first 1000 iterations as ‘burn in’, a further 1000 iterations were taken from the joint posterior. The residuals of the model were checked graphically against predictions with none showing any systematic pattern or severe heteroscedasticity. To ensure the effect of wood density was identifiable, and to examine it's effect on all three parameters (i.e growth-mortality intercept and slope, and growth-independent hazard) we selectively removed it from each and visually inspected whether the direction and magnitude of effects were severely altered. Below we describe the full model structure, parameters and priors. We also supply the stan code below.

We were interested in examining how wood density affected growth-dependent and growth-independent individual tree mortality.
However, our observations, $y_i$, were binary (0 = alive, 1 = dead) for each individual $i$. Consequently, we modeled these observations as a random realization from a Bernoulli distribution based on the model-fitted probability that individual $i$ would die, $p_i$:

\begin{equation} \label{eq:obs_model}
p_i \sim \textrm{bernoulli}(p_i) \end{equation}

We modelled the probability of drying, $p_i$, using a complimentary-log-log link, $\log_e(-\log_e(1-p))$. Unlike the traditional logit link, $\log_e(p/1-p)$, the complimentary-log-log allows regression coefficients to be interpreted as hazard ratios. That is, the hazard for one individual relative to another [@Kleinbaum:2012tn]. It is also asymmetrical and can explicitly account for variable census length [@Allison:1982vd; @Kleinbaum:2012tn], which is particularly important with large-scale monitoring programs such as BCI, where the period of time between revisits of individual trees varies within a single census because there are so many individuals that they cannot be observed simulataneously [@Condit:1995ux].

$p_i$ is modelled as a function of census length (ranging from 3.8 to 5.8 years) and the cumulative hazard $\lambda_i$ for each individual:

\begin{equation} \label{eq:pred_model}
\log_e(-\log_e(1-p_i)) = \log_e\left(\textrm{census-length}_i \times \lambda_i\right) 
\end{equation}

Here, the cumulative hazard, $\lambda_i$, is the sum of two independent hazards - growth-dependent hazard (i.e. death via carbon starvation) and growth-independent (death by all other causes). Growth-dependent hazard encapsulates the growth-mortality relationship by allowing the probability of dying to decrease exponentially with growth rate [@Buchman:1983vx; @Kobe:1997vy; @Wyckoff:2002ul; @Mantgem:2003dw]. This relationship consists of two species varying parameters $alpha$, the intercept term that defines the instantaneous hazard rate at zero growth, and $beta$, the slope term that defines the decrease in hazard rate per scaled unit growth (Fig.6). By contrast, the growth independent hazard is assumed to be linear and is defined by one species varying parameter, ho. Note: we estimate growth as $\frac{dbh_t - dbh_{t-1}}{\Delta{t}}$.

\begin{equation} \label{eq:lambda}
\lambda_i =
\left(
\overbrace{\exp\left(alpha_{s[i]} - \exp(beta_{s[i]}) \times
\frac{\textrm{growth}_i}{2 \times \sigma(\textrm{growth})}
\right)
}^{\text{Growth dependent hazard}} +
\overbrace{\exp(ho_{s[i]})
}^{\text{Growth independent hazard}}\right)
\end{equation}

```{r model description, fig.height=6,fig.width=6, echo=FALSE}
par(mfrow=c(2,1), mar=c(3,4,1,1), xaxs='i')
       curve(exp(1 -exp(-0.3) * x) + exp(-4), xlim=c(0,12), ylim=c(0,5),
             xlab=NA, ylab='Hazard rate',xaxt='n', col='red')
       arrows(x0 = 2, y0 = 2.7, x1 = 0 ,y1 = 2.7)
       text(3.1,2.7, 'alpha')
       arrows(x0 = 4, y0 = 1.5, x1 = 1.5 ,y1 = 1)
       text(4.5,1.7, 'beta')
       arrows(x0 = 11, y0 = 0.8, x1 = 11 ,y1 = 0.018)
       text(11,1, 'ho')
       axis(1, at=0, labels= 0)

       curve((1-exp(-(exp(1 - exp(-0.3) * x) + exp(-4))))*100, xlim=c(0,12), ylim=c(0,100),
             xlab=NA, ylab='Pr(Mortality)', xaxt='n', col='red')
       text(3.1,93, 'alpha')
       arrows(x0 = 2, y0 = 93, x1 = 0 ,y1 = 93)
       text(6,30, 'beta')
       arrows(x0 = 5, y0 = 30, x1 = 3 ,y1 = 30)
       text(11,15, 'ho')
       arrows(x0 = 11, y0 = 10, x1 = 11 ,y1 = exp(-4)*100)
       axis(1, at=0, labels= 0)
       mtext(side=1, 'Growth rate',line = 2)
```

**Fig 6:** Interpreting model parameters. Top = Hazard curves (i.e. instantaneous mortality rates); Bottom = Mortality probability/year based on estimated hazard rates. The intercept at zero growth is defined by $alpha$. The slope is defined by $beta$. The asymptote is defined by $ho$ and represents the growth-independent hazard.




We modelled $alpha$, $beta$ and $ho$, by allowing their intercepts to vary by species and by including wood density as a species level predictor:

\begin{equation} \label{eq:alpha}
alpha_s = \alpha0_s + \alpha1 \times \frac{(\log_e(\rho_s) - \mu(\log_e(\rho)))}{2 \times(\sigma(\log(\rho)))}
\end{equation}

\begin{equation} \label{eq:beta}
beta_s = \beta0_s + \beta1 \times \frac{(\log_e(\rho_s) - \mu(\log_e(\rho)))}{2 \times(\sigma(\log(\rho)))}
\end{equation}

\begin{equation} \label{eq:ho}
ho_s = \gamma0_s + \gamma1 \times \frac{(\log_e(\rho_s) - \mu(\log_e(\rho)))}{2 \times(\sigma(\log(\rho)))}
\end{equation}

Here, the terms $\alpha1$, $\beta1$ and $\gamma1$ represent the effect of wood density on the intercept, slope and growth-independent hazard, respectively. The terms, $\alpha0_s$, $\beta0_s$ and $\gamma0_s$, respectively represent the growth-dependent intercept and slope and growth-independent intercept for species $s$ within which individual $i$ belongs. We estimates these varying terms from a normal distribution centred on the average species intercept (i.e. $\alpha_{\mu}$,$\gamma_{\mu}$) or slope ($\beta_{\mu}$) and the standard deviation of the species variation ($\alpha spp$,$\beta spp$, $\gamma spp$).

\begin{equation} \label{eq:alpha0}
\alpha_s \sim \textrm{Normal}(\alpha_{\mu}, \sigma_{\alpha spp})
\end{equation}

\begin{equation} \label{eq:beta0}
\beta_s \sim \textrm{Normal}(\beta_{\mu}, \sigma_{\beta spp})
\end{equation}

\begin{equation} \label{eq:gamma0}
\gamma_s \sim \textrm{Normal}(\gamma_{\mu}, \sigma_{\gamma spp})
\end{equation}

Because we used Bayesian inference we needed to specify prior distributions for all model parameters. For wood density effects ($\alpha1$, $\beta1$ and $\gamma1$) and mean hyperparamters ($\alpha_{\mu}$, $\beta_{mu}$ and $\gamma_{\mu}$) we used stan's default uninformative prior, $\textrm{Uniform(-2,2)}. For hyperparamater standard deviations we used $\textrm{Uniform(0,2)}$.

\pagebreak

##Results
**Take home message:**
Wood density decreases intercept (log_a) & further increases the steepness of the growth-mortality slope (log_b). It also decreases the growth-independent hazard log_ho

```{r Model output, echo=FALSE}
print(stan_output_combined,probs = c(0.025,0.975), digits_summary = 3)
```

```{r Coefficient plot, fig.height=6,fig.width=6, echo=FALSE}
coeff_plot(stan_output_combined, params=c('c1','c0_mu','b1','b0_mu','a1','a0_mu'),
           labels = c('ho x wd','ho','beta x wd','beta','alpha x wd','alpha'),
           xlab = 'cloglog effect size', transform = NULL)
```

**Fig 7** log centered and scaled coefficients ± 95 (thin line) and 80% (thick line) Bayesian Credible Intervals. log_a = intercept; log_b = slope, log_ho = asymptote.


```{r Hazard rates,fig.height=6,fig.width=6, echo=FALSE}
par(mfrow=c(2,1),mar=c(4,3,1,1), xaxs='i')
plot_mortality(model_fit = stan_output_combined ,model_data = stan_data, cov_name = 'rho',
               wd_values = c(200,800), growth_name = 'growth_dt', mortality_curve = FALSE, xaxis_on = FALSE, haz_lim=c(0,2))

plot_mortality(model_fit = stan_output_combined ,model_data = stan_data, cov_name = 'rho',
               wd_values = c(200,800), growth_name = 'growth_dt', mortality_curve = TRUE, xaxis_on = TRUE, legend = FALSE)
```

**Fig 8** Predicted hazard rates (top) and mortality probability (bottom) for an average 200 (black) and 800 kg/m2 (red) kg/m2 wood density species. Errors are 95% credible intervals. rho = wood density.


```{r 3d plots, fig.height=10,fig.width=10, echo=FALSE}
par(mfrow=c(2,1))
plot3d(model_fit = stan_output_combined,
        model_data = stan_data, cov_name = 'rho',
        wd_values = seq(200,800, by=10),
        theta=145, phi=20,mortality_curve = FALSE)

plot3d(model_fit = stan_output_combined,
       model_data = stan_data, cov_name = 'rho',
       wd_values = seq(200,800, by=10),
       theta=145, phi=20,mortality_curve = TRUE)
```

**Fig 9** Mean predicted 3D surface for hazard rates (top) and mortality probability (bottom). Note that there is no 'significant' difference at low growth rate between low and high wood density. rho = wood density,This can be better seen in Fig. 8.

\pagebreak

##Notes/Questions

1 - How much data should we fit to this model? All of it would require the inclusion of a individual random effect to account for non-independence of repeatedly sampled individuals. We could subsample individuals in entire dataset... but again this would require non-independence to be account for. The advantage of this approach is we can also cross validate. Another way to cross validate is to run the model for each census on a subset of individuals spanning all species. Question is, how can we best stratify sampling to ensure low abundance species are also represented.

2 - Growth is a predominant predictor in mortality models, however, it is not the only one. Size is also commonly used as a predictor of mortality. A typical finding from these size-mortality models is that mortality appears to be U-shaped. Could we account for this by fitting dbh and dbh x wd interaction on the growth independent hazard (ho)? My concern is whether this makes sense as dbh and growth are highly correlated (~50%) consequently, these two predictors may not be identifiable.

3 - Possibly not a major concern with size not in the model, but currently the data only utilises data from individuals that are at least 1.3 m high and have a diameter of > 1 cm. This means that we are missing alot of the mortality at the young age. Is it worth investing time in cleaning and preparing the BCI seedling data for inclusion? A difficulty to face is that the seedling data measures height while the main BCI dataset measures dbh. Maybe some type of allometric model using BCI?

4 - Current model form at very low growth rate forces the hazard for high wood density species to become larger than low wood density species. Though this effect is not significant (95% credible intervals overlap)... it appears to be the result of the model form we are using. Discuss with Daniel.

5 - Set model up to run on cluster. I've managed to dramatically speed up convergence time with these models. Approximately 5 hours. However, if we plan to run models containing multiple combinations of 4 growth rate types x 3 parameter combinations. We will need to set this up on the cluster.

6 - Need to integrate code into remaker

\pagebreak

## K-fold Cross validation example excerp from [Vehtari & Gelman 2014](http://www.stat.columbia.edu/~gelman/research/unpublished/waic_stan.pdf)


To implement K-fold cross-validation in Stan we need to repeatedly fit the model to one subset of the data and use it to predict the held-out set. The way we recommend setting this up is to do the partitioning in R (or Python, or whatever data-processing environment is being used) and then pass the training data and held-out data to Stan in two pieces.
With linear regression, for example, we start with the Stan model on page 4, passing in the training data as N, y, X and the held-out set as N holdout, y holdout, X holdout, with the data block augmented accordingly. We then keep the data block and model as is, and just alter the generated quantities block to operate on the held-out data. The code looks like this:

```{r eval=FALSE}
􏰋
￼￼￼data { int N;
  int J;
vector[N] y;
matrix[N,J] X;
int N_holdout;
vector[N_holdout] y_holdout;
matrix[N_holdout,J] X_holdout;
}
  parameters {
    vector[J] b;
real<lower=0> sigma;
  }
  model {
    y ~ normal(X*b, sigma);
increment_log_prob(-log(sigma));
  }
  generated quantities {
    vector[N_holdout] log_lik;
for (n in 1:N_holdout){
  // data model
// log prior for p(sigma) propto 1/sigma
log_lik[n] <- normal_log(y_holdout[n], X_holdout[n]*b, sigma);
9
} }

```


\pagebreak

##References