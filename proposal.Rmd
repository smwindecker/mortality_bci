---
title: "Hazard rates, growth, size and plant traits"
author: "J Camac"
date: "10 Dec 2014"
output: pdf_document
bibliography: data/refs.bib
csl: downloads/style.csl
---
##Background

Understanding who lives or dies, and why, is an integral component of natural selection, and is crucial for building better individual-based models of population and community dynamics. However, ecologists have barely begun to tap the information available in survival data. For plants, this untaped information has resulted in few mechanistic models of plant mortality (Hawkes_2000). The reason for this may be due to past and current work primarily focusing on modelling plant growth as opposed to mortality (Hawkes 2000). But it also may be a consequence of difficulties associated with modelling mortality. 

Plant mortality is highly variable and episodic in both space and time (Burgmann 1994). It varies between species and between individuals within a species. This variability is thought to be affected by age (REF), size (REF) and genetics (REF) but also by multiple biotic and abiotic factors which may interact with one another (e.g. drought and herbivory: McDowell 2011). Because of this complexity, calibrating empirical models or validating mechanistic models of plant mortality requires datasets that monitor large numbers of individuals across entire lifespans and across multiple biotic and abiotic gradients. Furthermore, it also requires that causes of death to be identified for each individual. However, few, if any, field datasets meet all these requirements. Instead, most plant survival data come from monitoring programs conducted at few sites, that monitor survival as a binary event, with no delimintation of cause of death, often for periods shorter than that required to capture an individual or species entire lifespan (Bugmann 1996). 

Currently, most models examining plant mortality have been correlative. In a review of 61 woody plant mortality models, Hawke (2000) found that only 4 were mechanistic and 57 were correlative. These models typically include correlations with one or multiple, abiotic and biotic factors such as competition (REF) and climate (REF) as well as state variables such as age (REF), size (Hurst et al 2011, Vieilledent et al. 2009, Yang et al. 2003) and growth rate (Vielledent et al. 2010, Wright et al 2010). More recently, plant traits have also been incorporated into such correlative models to examine inter-specific variability in mortality rates (e.g. Kitajima et al 2013, Wright et al. 2010) and improve model generality so that predictions can be made to new species outside the fitted data (REF). Trait-based mortality analysis have found that several traits are correlated with plant mortality rates. For example, wood density has been shown within BCI to be negatively correlated with mortality rates. Bark thickness (Pausas et al 2014) and being decidious (???) relative to evergreen has also been shown to reduce mortality after events such as fire and drought, respectively.

While measures of fitness such as reproductive success have typically been quantified at the individual level, mortality is commonly quantified at the population level (Zan et al 2010, Sheil et al 1995). The finite population mortality rate, $M_{finite}$, a time discrete measure of mortality, is one common way that ecologists have examined mortality. Here, $M_{finite}$ is estimated as the complement of the ratio of final population size, $N_T$, to initial population size, $N_0$, divided by the length of the observation period, $T$,

\begin{equation}\label{eqn:finitepopmortrate}
M_{finite} = 1 - \frac{N_T/N_0}{T}.
\end{equation}

However, in order to estimate the expected proportion of individuals surviving for periods shorter or longer than that used to calculate the $M_{finite}$, time must be treated as continuous, and the instantaneous population mortality rate (also known as the population hazard rate), $\lambda_{pop}$ needs to be calculated:

\begin{equation}\label{eqn:poplambda}
\lambda_{pop} = -\frac{\log_e(1 - S))}{T}.
\end{equation}
and 

\begin{equation}\label{eqn:S}
S = 1 - \exp{(-\lambda T)},
\end{equation}

where $S$ is the proportion of individuals that survive.

In plant ecology, these functions have become common place in describing the loss of individuals from a population (e.g. Zens et al 2003, Condit, Hubbell & Fores). They have also been correlated with other covariates. For example, Wright et al (2010) quantified the finite population mortality rate for 103 tree species and then correlated these values with species level growth and wood density estimates. However, a fundamental problem with these population estimates of mortality is that they ignore individual variability and as such implicitly assume that all individuals are the same and experience the same likelihood of dying (i.e. the same hazard rate). Such an assumption violates the basic pretense of natural selection (REF). Individuals within a population are not identical, they vary genetically, typically span a range of sizes and ages, and are exposed to different levels of resources and abiotic and biotic pressures. The consequence of ignoring this important source of variability is that population estimates of mortality rates are likely to be biased and may severely limit the predictive capacity of population and community dynamic models (Zens et al 2003, Shiel et al 1995). Regardless of the method used, bias is an inevitable product of any heterogenous sample. It can, however, be reduced if the levels of heterogeneity are recognized and explicitly incorporated into analyses. 

Individual-based models of mortality or survival are one way to account for variable hazards and minimise associated biases at the population level. These models have been extensively applied in other disciplines (REFS), but are only now becoming regularly used in ecology and evolution (e.g. REFs, Zens et al 2003). At the core of all survival models is a hazard function which defines the instantaneous potential per unit time, $\lambda(t)$ for the event (in this case death) to occur, given that the individual has survived up to time $t$:

\begin{equation} \label{eq:lambda} \lambda(t) = \lim_{dt \rightarrow 0} \frac{\Pr(t \leq T < t+dt)}{dt\cdot S(t)} = -\frac{S'(t)}{S(t)}.\end{equation}

The hazard function is intimately related to the survival function, which gives the probability $S$ that an event does not occur before a given time $T$:

$$ S(t) = \Pr(T > t)$$
where "Pr" is the probability and $T$ is a random variable denoting the time of event. For a particular individual, $S(t)$ gives the expected probability that it will survive from $0 \rightarrow t$.

In ecology, individual-based survival models that have been used include mark-recapture (Pollock et al 1995), survival analysis (Cox & Oakes 1984) and logistic regression (Allison 1982). Mark-recapture methods are typically applied to animal populations when it is uncertain whether marked individuals will be reencountered and mortality rates are estimated in light of this uncertainty. By contrast, survival analysis is used when accurate estimates of time of event (i.e. death) can be obtained, which commonly is not the case for most plant census data. However, survival analysis has been applied to tree-death data, with incremement growth being used as a surrogate for the passage of time (Woodall, Grambsch & Thomas 2005).

The logistic regression family of methods are the most common individual-based models used to analyse plant mortality data (e.g. Breece, Kolb & Dickson 2008, Carus 2010, Flewelling & Monserud 2002). This is because most plant-death datasets are interval-censored; that is they only record the binary state of an individual between two time points $t_1$ and $t_2$. These models consider tree death $\Pr(y_i =1)$, as a series of binomially distributed data with the probablity of observing death as function of a covariates $X_i$, associated coefficients, $\beta$, and a baseline hazard $\lambda_0$ related via a link function, typically a logit $\log_e(p/1-p)$. Here, the coefficients explain differences in individual hazards and as such reduce the bias found in population estimates (Zens & Peart 2003).

\begin{equation} \label{eq:logit}
\log(\frac{\Pr(y_i = 1)}{1 - Pr(y_i = 1)} =  \sum_{i=1}^n \beta X_i\ + \lambda_0. 
\end{equation}

Although the logit (see\ref{eq:logit}) is often used, the complimentary-log-log, $\log_e(-\log_e(1-p))$ link is more advantageous in survival analysis. This is because it makes the regression model equivalent to proportional hazards model (see below) in that coefficients are interpreted as hazard ratios. That is, the hazard for one individual relative to another(Kleinbaum et al 2012). It also reduces bias due to long and variable census intervals (Allison, 1982), which is particularly important with large-scale monitoring programs such as BCI, where the period of time between revisits of individual trees varies within a single census because there are so many individuals that they cannot be observed simulataneously (Conduit 1995).

\begin{equation} \label{eq:cloglog}
\log_e\left(\log_e\left(1-\Pr(y_i = 1)\right)\right) =  \sum_{i=1}^n \beta_i X_i\ + \lambda_0 t. 
\end{equation}.

The proportional hazards model assumes a hazard function with form:

\begin{equation} \label{eq:prop_hazards} \lambda(t) =  \lambda_0(t) \exp\left(\sum_{i=1}^n \beta_i x_i\right) =   \lambda_0(t)\prod_{i=1}^n \exp\left( \beta_i x_i\right),\end{equation}

where $X_1, \ldots, X_n$ are various risk factors and $\beta_1, \ldots, \beta_n$ are associated coefficients. This leads (via eq. \ref{eq:HazS2}) to the following model for survival:

\begin{equation} \label{eq:prop_hazards_S}
S(t) =  \exp\left(\exp\left(-\sum_{i=1}^n \beta_i x_i\right)\right) S_0(t), \end{equation}

where $S_0(t) = \exp\left(-\int_0^t \lambda_0(t)\right)$ is the baseline survival function (i.e.

A key assumption of the proportional hazards model is that the relative risk from different predictors remains constant over time. For example, if being a particular size halved your hazard at time 0, it also halves your hazard at time 1 or any value of t (Kleinbaum et al 2012). However, these models can be extended to allow for individual covariates to vary over time (Kleinbaum et al 2012) and also include additive smoothing terms or hierarchical model structures.

In general, these models are applied to data where a single event is being considered. However, when there are at least two possible pathways leading to any given outcome (e.g., death from any of several causes), the problem is characterized as a competing risk problem (Kleinbaum et al 2012). For example, if there are two alternative and independent mechanisms leading to plant death such as death by insufficient carbon and wind throw. The hazard function then has form:

\begin{equation} \label{eq:additive_hazards} 
\lambda(t) =  \lambda_{carbon}(t) + \lambda_{windthrow}(t) ,
\end{equation}

leading to the survival function

\begin{equation} \label{eq:additive_hazards_S} S(t) =  \exp\left( - \int_0^t \lambda_{carbon}(t) + \lambda_{windthrow}(t) \, \textrm{d} t\right) =  \exp\left( - \int_0^t \lambda_{carbon}(t) \textrm{d} t\right)\exp\left( - \int_0^t \lambda_{windthrow}(t) \textrm{d} t\right).
\end{equation}

In the same way as we did for single event, each event may  be related to a number of covariates through a proportional hazards model, such that

\begin{equation} 
\lambda_{carbon}(t) =  \lambda_{carbon,0}(t) \exp\left(\sum_{i=1}^n \beta_{i,1} x_i\right),
\end{equation}
and
\begin{equation} 
\lambda_{windthrow}(t) =  \lambda_{windthrow,0}(t) \exp\left(\sum_{i=1}^n \beta_{i,2} x_i\right).
\end{equation}

We then have a model of the form

\begin{equation} \label{eq:additive_hazards_S2} 
S(t) =  S_{0}(t) \times \exp\left(\exp\left(-\sum_{i=1}^n \beta_{i,2} x_i\right)\right) \times \exp\left(\exp\left(-\sum_{i=1}^n \beta_{i,1} x_i\right)\right),
\end{equation}

where $S_{0}(t)=\exp\left(-\int_0^t \lambda_{carbon,0}(t)\right) \exp\left(-\int_0^t \lambda_{windthrow,0}(t)\right)$ is combined baseline hazard function.

If the different time-of-event is known for each event type, a competing risk analysis can be used to estimate the underlying covariates (essentially this involves partitioning the dataset into two, one for each type of event, and adjusting the population sizes to account for deaths due to the other event)(kleinbaum 2005).

The challenge here is to see if we can estimate the parameters of eq.  \ref{eq:additive_hazards_S2} using interval-census data where we do not know what tree died of.


### PROJECT 1: A competing risks problem
Plants can be killed by 1) not assimulating enough carbon for cell maintenance (i.e. carbon starvation), or 2) by some event that fatally damages the plant (e.g. fire, herbivory, windthrow). Ecologists have attempted to model the effects of insufficient carbon on hazard rates by using various measures of plant growth as a proxy for the carbon budget (e.g. Wright et al 2010). They have also used plant size and plant traits such as wood density as predictors of mortality. 

However, as far as I am aware, no study has attempted to partition these effects into a competiting risk problem, whereby death by carbon starvation is treated independently to the effect of wood density which may influence the susceptiblitly to other causes of death. Here, I attempt to do build a multiplicative and additive hazards model using interval-censored data in a logistic regression framework.

This project is made up of a series of questions examining how wood density, growth rates and size influence plant mortality rates.

-1 Can we use a competing risks framework to attempt to estimate cause of death? (i.e. by treating the effects of growth, size and wood density as independent causes of mortality)
-2 How do the findings of a competing risks approach differ from standard logistic regression? Are there any additional insights that can be gleamed? 
-3 How does wood density, growth and size influence mortality rates and how do the magnitude of effects compare?
-4 Can interactive terms be included in a competing risk framework? Is the presence of a interaction nullify the independence assumption of competing risks?
-5 What measure of growth or size (i.e. dbh, basal or mass - absolute or relative) best predicts mortality rates?


#### Competing hazard models
Here I attempt to fit a competing hazards model using interval-censored data where we don the following Bayesian logistic regression form:

\begin{equation}\label{eqn:wd_grmod_inter}
\overbrace{\log(-\log(1 -\Pr(y_{i,t} = 1)))}^{\text{Survival Probability}} =
\overbrace{\log(\Delta{t})}^{\text{census interval}} + \log\left(\lambda_0 + \lambda_1 + \lambda_2 \ldots \lambda_n\right). 
\end{equation}

**Hazards currently fitted to data**
Below I assume negative exponential relationships between mortality and growth rate, wood density and size. In these models the $\alpha$'s refer to the intercept and the $\beta$'s refer to the rate of change. In a competing risks framework each $\lambda$ is assumed to be independent of eachother. I've ran these models with different variants of growth (e.g. incremental dbh and basal growth and relative growth rates of each) in an attempt to determine which is the best predictor of mortality.

\begin{equation}\label{eqn:indhaz}\begin{array}{ll}
\lambda_0 = &
\overbrace{\alpha_0}^{\text{baseline/unexplained}} 
\\
\\

\lambda_1 = &
\overbrace{\alpha_1 \times \exp{(-\beta_1 \times gr)}}^{\text{growth dependent hazard}} 
\\
\\

\lambda_2 = &
\overbrace{\alpha_2 \times \exp{(-\beta_2 \times \log(wd))}}^{\text{wd dependent hazard}} 
\\
\\
\end{array} \end{equation}

**Example JAGS competing risk model with no random effects**

```{r, eval=FALSE}
models <- c('dbh_gr','dbh_rgr','basal_gr', 'basal_rgr')
nmodels <-length(models)
output <- list()
inits <- function() {
              list(    
              alpha0 = rlnorm(1,-3, 0.01),
              alpha1 = rlnorm(1,-3, 0.01),
              alpha2 = rlnorm(1,-3, 0.01),
              beta1 = rlnorm(1,-0.5, 0.01),
              beta2 = rlnorm(1,0, 0.01))
              }

for (i in 1:nmodels) {
  cat(sprintf('
              model {
              for(it in 1:n_obs) {
              died[it] ~ dbern(p[it])
              cloglog(p[it]) <- log(census_length[it]) + 
              log(alpha0 + alpha1 * exp(-beta1 * log(wd[spp[it]])) + alpha2 * exp(-beta2 * %s[it]))
              }
              
              #Priors
              alpha0 ~ dlnorm(0, 0.01) 
              alpha1 ~ dlnorm(0, 0.01) 
              alpha2 ~ dlnorm(0, 0.01)
              beta1 ~ dlnorm(0, 0.0001)
              beta2 ~ dlnorm(0, 0.0001)
              
              }',models[i]),file=(tmp <- tempfile()))
  
  system.time(output[[models[i]]] <- 
                      jags.parallel(
                        model.file = tmp,
                        n.iter = 30000,
                        data= names(data), 
                        envir=list2env(data),
                        inits = inits,
                        parameters.to.save = c('alpha0','alpha1','alpha2','beta1','beta2')))
  }
```

**Preliminary results of competing risk models**

TO BE ADDED


**Further extensions still to do**
- Add a hazard effect of size? What would the shape of this be? Preliminary analysis of mortality vs dbh suggests that most species exhibit a U-shape mortality curve.
- Validate that a negative exponential is a reasonable assumption for the effects of growth and wood density. This could be done via partial dependency plots and non-parametric approaches.
- Cross validate models

**Size mortality relationships**

TO BE ADDED


### PROJECT 2: LITERATURE REVIEW. Examine which plant traits influence mortality rates under common hazards (e.g. wind throw, drought, fire, disease, herbivory) experienced by vegetation.
### Hazard Hypotheses
1. The most common hazards that can result in plant death are all size dependent and include:
**Competition**: This hazard will most strongly affect smaller individuals because they are more at risk of being shaded compared to larger plants. Traits affecting the likelihood of competition resulting in death will be correlated with shade tolerance such as *LMA* and *wood density*.

**Herbivory**: This hazard will most strongly affect small individuals more susceptible to complete foliage loss or being consumed entirely. Traits affecting the liklihood of herbivory resulting in death will be correlated with herbivory preference (e.g. *leaf nitrogen*), resistance (e.g. *wood density*) and persistance (*resprouting capabilities*).

**Fire**: This hazard is likely to be size dependent with small individuals more suspectible to fire compared to larger plants. This is because for small/juvenile plants will are less likely to have developed fire-resistant traits. They are also lower in stature making their leaves exposed to both low severity and high severity fires. Traits affecting the likelihood of fire resulting in death will be correlated with fire-resistance (e.g. bark thickness) and persistance (e.g. resprouting)

**Drought/Extreme heat/ Extreme cold**: These hazard is likely to affect smaller plants moreso than larger plants.



### PROJECT 3: Process-based model - coming from first principles
Build a process-based mortality model that allows trait effects to interact with the type of hazard as well as growth and size. 

###Factors influencing small individuals
```{r, echo=FALSE}
par(xaxs='i', yaxs='i', mfrow= c(3,2))
curve(1/(1+((1/0.99)-1)*exp(5*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by fire', lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.99)-1)*exp(7*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by drought',lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.99)-1)*exp(7*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by high temperatures',lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.99)-1)*exp(7*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by low temperatures',lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.99)-1)*exp(7*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by herbivory',lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.99)-1)*exp(15*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by light competition', lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))
```

###Factors influencing large individuals
```{r, echo=FALSE}
par(xaxs='i', yaxs='i',mfrow=c(1,3))
curve(1/(1+((1/0.02)-1)*exp(-10*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by wind fall', lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(0.9/(1+((0.9/0.2)-1)*exp(-7*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by falling neighbour',lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.001)-1)*exp(-8*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Time', main='Death by disease',lwd=2)
axis(1, at=c(0,1.2), labels=c('0', 'infinity'))
```

###Traits are likely to affect shape of these hazard rates
```{r, echo=FALSE}
par(xaxs='i', yaxs='i', mfrow=c(1,2))
curve(1/(1+((1/0.02)-1)*exp(-10*x)), ylim=c(0,1), xlim=c(0, 2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by wind fall')
curve(1/(1+((1/0.02)-1)*exp(-5*x)), ylim=c(0,1), xlim=c(0, 2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by wind fall', add=T, col='red', lty=2, lwd=2)
axis(1, at=c(0,2), labels=c('Small', 'Large'))
legend(0.7,0.2, legend = c('low wd', 'high wd'), col=c('black','red'), lty=c(1,2), bty = 'n', lwd=2, cex=2,)

curve(1/(1+((1/0.02)-1)*exp(-10*x)), ylim=c(0,1), xlim=c(0, 2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by wind fall')
curve(1/(1+((1/0.02)-1)*exp(-5*x)), ylim=c(0,1), xlim=c(0, 2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by wind fall', add=T, col='red', lty=2, lwd=2)
axis(1, at=c(0,2), labels=c('Small', 'Large'))
legend(0.7,0.2, legend = c('low severity', 'high severity'), col=c('black','red'), lty=c(1,2), bty = 'n', lwd=2, cex=2,)
```



# REFERENCES








