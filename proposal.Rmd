---
title: "Mortality Project"
author: "J Camac"
date: "9 July 2014"
output: pdf_document
bibliography: data/refs.bib
csl: downloads/style.csl
---

###Background

Plant mortality and the processes affecting it are integral to understanding vegetation dynamics. However, few mechanistic models of vegetation dynamic explicitly simulate mortality (Hawkes_2000), and those that have, do so using little process-based information. For example, mechanistic models have accounted for plant mortality by assuming mortality rates are constant through time and space (Thorton 2007m White 2000, Delbart et al 2010) or that they change when a threshold has been surpassed (e.g. when Sitch et al 2003, Sato et al 2007). These simplifications are a result of a lack of process-based information on what causes mortality rates to vary temporally, spatially and between species (Hawkes 2000, McDowell et al 2011). In part, this is because researchers have placed a greater emphasis on modelling plant growth (Hawkes 2000). But it is also due to the difficulties associated with modelling mortality rates. 

Temporal patterns in plant mortality are highly variable and episodic (Burgmann 1994). Mortality rates also vary between species and are strongly influenced by multiple biotic and abiotic factors that may interact with one another (e.g. drought and herbivory: McDowell 2011). Because of this complexity, calibrating empirical models or validating mechanistic models of plant mortality requires datasets that monitor large numbers of species and individuals across their lifespan and across multiple biotic and abiotic gradients. More importantly, it requires the cause of death to be known for each individual. However, few, if any, data meet all these requirements. Rather, most available data comes from monitoring programs that are usually shorter than many plants lifespans (Bugmann 1996), and that focus on single species at single sites. Furthermore, because of the inherent difficulty of defining the cause of death, most monitoring programs do not delimit the cause of death for each individual.

Consequently, there are very few mechanistic mortality models. In a review of 61 woody plant mortality models, Hawke (2000) found that only 4 were mechanistic. In these models, mortality occurred when carbon supply was insufficient for growth (e.g. Friend et al. 1997, Bossel 1986, Weinstein et al 1991, Bugmann et al 1997). By contrast, the majority of mortality models (57) were empirical and included forest yield models (Guan and Gertner 1991), gap models (Dale et al 1985), plant-environment models (King and Grant 1996) and spatial models (Jeltsch et al 1997). These empirical mortality models spanned the range from deterministic (REFS) to stochastic (REFS) and typically included correlations of one or multiple, abiotic and biotic factors such as competition (REF) and climate (REF) as well as state variables such as age (REF), size (Hurst et al 2011, , Vieilledent et al. 2009, Yang et al. 2003) and growth rate (Vielledent et al. 2010, Wright et al 2010).

More recently, plant traits have been incorporated into empirical models in order to examine inter-specific variability in mortality rates (e.g. Kitajima et al 2013, Wright et al. 2010). Such studies have found several traits that are correlated with mortality rates. For example, several studies (Wright et al 2010) have found that species with higher wood density exhibit lower mortality rates relative to species with low wood density. This is thought to be due to higher construction costs resulting in stronger stems and branches that are less susceptible to breakage and wood herbivory (REFS). Bark thickness has also been correlated with greater survival after fire due via greater insulating properties (Pausas et al in press). Or having a deciduous life form often allows for greater survival during prolonged drought by allowing plants to essentially hibernate during periods of high water stress, relative to evergreen species. However, the vast majority of these studies assume that the effects of traits remain do not interact with changing environmental conditions or individual state variables such as growth rate or size. This is despite theory suggesting otherwise. For example wood density is likely to matter more for an adult plant then a juvenile plant because adults are taller and are more prone to being knocked over by windthrow, whereas juveniles are likely to be more sheltered by surrounding taller vegetation.

Below I briefly outline three projects that attempt to improve our understanding of how plant traits can influence mortality rates.

**PROJECT 1.**
Examine whether the effects of wood density (and other traits) on mortality are growth or size dependent

**PROJECT 2.**
Examine which plant traits influence mortality rates under common hazards (e.g. wind throw, drought, fire, disease, herbivory) experienced by vegetation.

**PROJECT 3.**
Build a process-based mortality model that allows trait effects to interact with the type of hazard as well as growth and size. 


##PROJECT 1 - Growth-Size independent and interactive effects of wood density

###Brief summary
Plant traits are often fitted to empirical mortality models without the examination of how they may interact with state variables such as size and growth rate. However, traits such as wood density are likely to influence mortality rates by both state-independent and state-dependent effects. For example, wood density may reduce wood herbivory irrespective of plant size. But it may also have additional effects on mortality rates that only become biologically significant as a plant gets larger. Higher wood density, for example, may reduce stem breakage; a hazard more likely to occur as a plant gets taller and more exposed to wind. Similarly, wood density may also interact with growth rates, whereby individuals with low growth rates and low wood density may be more susceptible to pathogens relative to individuals that have higher wood density.

Here, I examine how plant traits affect mortality rates by partitioning effects into growth or size-independent effects and growth or size-dependent effects.

Sub-questions:
1) What is the best growth rate metric to use? dbh, basal area?, mass?
2) Are trait effects predominately growth dependent or independent?
3) Out of these series of hazards, which combination best predicts plant mortality in BCI?
RGR decreases with size. Incr.GR increases with size. By including both growth rate and size in the model we can determine whether size has additional affects that are not explained by growth.


####
# Series of hazards
GROWTH DEPENDENT & INDEPENDENT EFFECTS

\begin{equation}\label{eqn:wd_grmod_inter}
\overbrace{\log(-\log(S(i,t)))}^{\text{Survival Probability}} =
\overbrace{\log(\Delta{t})}^{\text{census interval}} + \log\left(\lambda_0 + \lambda_1 + \lambda_2 ... \lambda_n\right). 
\end{equation}


\begin{equation}\label{eqn:indhaz}\begin{array}{ll}
\lambda_0 = &
\overbrace{\alpha_0}^{\text{baseline/unexplained}} 
\\
\\

\lambda_1 = &
\overbrace{\alpha_1 \times \exp{(-\beta_1 \times gr)}}^{\text{growth dependent}} 
\\
\\

\lambda_2 = &
\overbrace{\alpha_2 \times \exp{(-\beta_2 \times \log(wd))}}^{\text{wd dependent}} 
\\
\\

\lambda_3 = &
\overbrace{\alpha_3 \times \exp{(-\beta_3 \times \log(wd) + -\beta_4 \times gr)}}^{\text{wd independent and dependent}} 
\\
\\

SIZE DEPENDENCY

\begin{equation}\label{eqn:wd_grmod_inter}
\overbrace{\log(-\log(S(i,t)))}^{\text{Survival Probability}} =
\overbrace{\log(\Delta{t})}^{\text{census interval}} + \log\left(\lambda_1 + \lambda_2 ... \lambda_n\right). 
\end{equation}

\begin{equation}\label{eqn:indhaz}\begin{array}{ll}
\lambda_1 = &
\overbrace{\alpha_0}^{\text{baseline/unexplained}} 
\\
\\

\lambda_2 = &
\overbrace{\alpha_1 \times \exp{(-\beta_1 \times \log(size))}}^{\text{negative effect of size}} 
\\
\\

\lambda_3 = &
\overbrace{\alpha_2 \times \exp{(\beta_2 \times \log(wd))}}^{\text{positive effect of size}} 
\\
\\
\lambda_4 = &
\overbrace{\alpha_3 \times \exp{(-\beta_3 \times \log(wd))}}^{\text{wd effect}} 
\\
\\
\lambda_5 = &
\overbrace{\alpha_4 \times \exp{(-\beta_4 \times \log(size) + -beta_5 \times \log(wd))}}^{\text{wd-size positive effect}} 
\\
\\
\lambda_6 = &
\overbrace{\alpha_5 \times \exp{(\beta_6 \times \log(size) + \beta_7 \times \log(wd))}}^{\text{wd-size negative effect}} 
\end{array} \end{equation}

**Things to consider:** 
How to include interactive effects... and what are their meaning?
- Is it reasonable to assume that growth a size dependent and independent hazards have different baseline hazards?
- Preliminary analysis suggests that the alpha's are non identifiable when multiple hazards are included.
- Do not assume a functional form (in this case we assume an negative exponential effect), but instead use some non-parametric approach to give us ideas of about the curves. - This is partly done using the K-M plots but are difficult to interpret as typically associated with categorical predictors, whereas we have continuous.

###Example JAGS model with no random effects

```{r, eval=FALSE}
library('dplyr')
library('R2jags')
#Loads BCI data and attaches trait data
load('../data_BCI/output/bci.mainstem.Rdata')
bci.traits <- read.csv('../data_BCI/rawdata/traits/BCI_traits_20101220.csv')
names(bci.traits) <- tolower(names(bci.traits)) # lowers trait column names for merging
bci.traits$sp <- tolower(bci.traits$sp) # lowers species code names for merging
bci.mainstem <- merge(bci.mainstem,bci.traits[,c('sp','sg100c_avg')],by = 'sp') #only uses species trait data exists for.
rm(bci.traits) # trait db no longer needed

#Subsets data to only include species with traits and has a status record.
#Also removes couple of rows that have 10 yr census intervals.
#Then adds a sp.id column
bci.mainstem<- bci.mainstem %>%
  filter(!is.na(census.interval) & !is.na(sg100c_avg) & !is.na(dead.next.census) & census.interval< 6) %>%
  mutate(sp.id = as.numeric(factor(sp)))

  #Preps data for model by centering and scaling predictors and time
  data <- list(
  n_obs = nrow(bci.mainstem),
  #n_spp = length(unique(bci.mainstem$sp)),
  spp = as.numeric(factor(bci.mainstem$sp), as.character(unique(bci.mainstem$sp))),
  ln_cswd = scale(log(unique(bci.mainstem[c('sp', 'sg100c_avg')])[,'sg100c_avg']),center=FALSE)[,1]/2,
  #dbh = scale(bci.mainstem$dbh)[,1]/2,
  dbh_gr = scale(bci.mainstem$dbh.gr)[,1]/2,
  #dbh_rgr = scale(bci.mainstem$dbh.rgr)[,1]/2,
  #basal_area = scale(bci.mainstem$basal.area)[,1]/2,
  #basal_gr = scale(bci.mainstem$basal.area.gr)[,1]/2,
  #basal_rgr = scale(bci.mainstem$basal.area.rgr)[,1]/2,
  census_length = bci.mainstem$census.interval, #logged for model
  died = bci.mainstem$dead.next.census)

#Actual model
model <- function(x) {
  for(it in 1:n_obs) {
    
    died[it] ~ dbern(p[it])
    cloglog(p[it]) <- log(census_length[it]) + log(alpha0 + alpha1 * exp(-beta1 * ln_cswd[spp[it]] + alpha2 * exp(-beta2 * dbh_gr[it])))
    }
  
  #Priors
  alpha0 ~ dlnorm(0, 0.0001) # Must be positive or large growth rates are undefined.
  alpha1 ~ dlnorm(0, 0.0001) # Can be positive or negative (but theory would suggest positive)
  alpha2 ~ dlnorm(0, 0.0001) # Has to be positive or small growth rates not defined
  beta1 ~ dnorm(0, 0.0001) # Can be positive or negative
  beta2 ~ dnorm(0, 0.0001)
  
  }
mod3<-     jags.parallel(model.file = model,
                        n.iter = 20000,
                        data= names(data), 
                        envir=list2env(data),
                        inits = NULL,
                        parameters.to.save = c('alpha0','alpha1','alpha2','beta1','beta2'))
```

#Potential Stan Model
```{r, eval=FALSE}
library(parallel)
library(rstan)
library(dplyr)
#Loads BCI data and attaches trait data
load('../data_BCI/output/bci.mainstem.Rdata')
bci.traits <- read.csv('../data_BCI/rawdata/traits/BCI_traits_20101220.csv')
names(bci.traits) <- tolower(names(bci.traits)) # lowers trait column names for merging
bci.traits$sp <- tolower(bci.traits$sp) # lowers species code names for merging
bci.mainstem <- merge(bci.mainstem,bci.traits[,c('sp','sg100c_avg')],by = 'sp') #only uses species trait data exists for.
rm(bci.traits)

#Subsets data to only include species with traits and has a status record.
#Also removes couple of rows that have 10 yr census intervals.
#Then adds a sp.id column
bci.mainstem<- bci.mainstem %>%
  filter(!is.na(census.interval) & !is.na(sg100c_avg) & !is.na(dead.next.census) & census.interval< 6) %>%
  mutate(sp.id = as.numeric(factor(sp)))

data <- list(
  n_obs = nrow(bci.mainstem),
  #n_spp = length(unique(bci.mainstem$sp)),
  #pp = as.numeric(factor(bci.mainstem$sp), as.character(unique(bci.mainstem$sp))),
  wd = scale(log(bci.mainstem$sg100c_avg*1000),center = FALSE)[,1]/2,
  #dbh = scale(bci.mainstem$dbh)[,1]/2,
  dbh_gr = scale(bci.mainstem$dbh.gr, center = FALSE)[,1]/2,
  #dbh_rgr = bci.mainstem$dbh.rgr,
  #basal_area = scale(bci.mainstem$basal.area)[,1]/2,
  #basal_gr = scale(bci.mainstem$basal.area.gr,center = FALSE)[,1]/2,
  #basal_rgr = scale(bci.mainstem$basal.area.rgr)[,1]/2,
  census_length = bci.mainstem$census.interval, #logged for model
  died = bci.mainstem$dead.next.census)
cat('
    data {
    int<lower=0> n_obs;
    int<lower=0, upper=1> died[n_obs];
    vector[n_obs] census_length;
    vector[n_obs] wd;
    vector[n_obs] dbh_gr;
    
    }
    parameters {
    real<lower=0> alpha0;
    real<lower=0> alpha1;
    real<lower=0> alpha2;
    real<lower=0> beta1;
    real<lower=0> beta2;
    } 
    model {
    for (it in 1:n_obs)
    died[it] ~ bernoulli(inv_cloglog(log(census_length[it]) + 
    log(alpha0 + alpha1 * exp(-beta1 * wd[it]) + alpha2 * exp(-beta2 * dbh_gr[it]))));
    }
    ', file=(StanModel <- tempfile()))
  				
system.time(BCImodel <- sflist2stanfit(mclapply(1:2,mc.cores=2,
		function(i) stan(file=StanModel, inter=4000, data=data,seed=123, chains=1, chain_id=i, refresh=-1))))
```



##PROJECT 2
### Hazard Hypotheses
1. The most common hazards that can result in plant death are all size dependent and include:
**Competition**: This hazard will most strongly affect smaller individuals because they are more at risk of being shaded compared to larger plants. Traits affecting the likelihood of competition resulting in death will be correlated with shade tolerance such as *LMA* and *wood density*.

**Herbivory**: This hazard will most strongly affect small individuals more susceptible to complete foliage loss or being consumed entirely. Traits affecting the liklihood of herbivory resulting in death will be correlated with herbivory preference (e.g. *leaf nitrogen*), resistance (e.g. *wood density*) and persistance (*resprouting capabilities*).

**Fire**: This hazard is likely to be size dependent with small individuals more suspectible to fire compared to larger plants. This is because for small/juvenile plants will are less likely to have developed fire-resistant traits. They are also lower in stature making their leaves exposed to both low severity and high severity fires. Traits affecting the likelihood of fire resulting in death will be correlated with fire-resistance (e.g. bark thickness) and persistance (e.g. resprouting)

**Drought/Extreme heat/ Extreme cold**: These hazard is likely to affect smaller plants moreso than larger plants.

###Factors influencing small individuals
```{r, echo=FALSE}
par(xaxs='i', yaxs='i', mfrow= c(3,2))
curve(1/(1+((1/0.99)-1)*exp(5*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by fire', lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.99)-1)*exp(7*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by drought',lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.99)-1)*exp(7*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by high temperatures',lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.99)-1)*exp(7*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by low temperatures',lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.99)-1)*exp(7*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by herbivory',lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.99)-1)*exp(15*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by light competition', lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))
```

###Factors influencing large individuals
```{r, echo=FALSE}
par(xaxs='i', yaxs='i',mfrow=c(1,3))
curve(1/(1+((1/0.02)-1)*exp(-10*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by wind fall', lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(0.9/(1+((0.9/0.2)-1)*exp(-7*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by falling neighbour',lwd=2)
axis(1, at=c(0,1.2), labels=c('Small', 'Large'))

curve(1/(1+((1/0.001)-1)*exp(-8*x)), ylim=c(0,1), xlim=c(0, 1.2), xaxt='n', ylab= 'Mortality rate', xlab='Time', main='Death by disease',lwd=2)
axis(1, at=c(0,1.2), labels=c('0', 'infinity'))
```

###Traits are likely to affect shape of these hazard rates
```{r, echo=FALSE}
par(xaxs='i', yaxs='i', mfrow=c(1,2))
curve(1/(1+((1/0.02)-1)*exp(-10*x)), ylim=c(0,1), xlim=c(0, 2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by wind fall')
curve(1/(1+((1/0.02)-1)*exp(-5*x)), ylim=c(0,1), xlim=c(0, 2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by wind fall', add=T, col='red', lty=2, lwd=2)
axis(1, at=c(0,2), labels=c('Small', 'Large'))
legend(0.7,0.2, legend = c('low wd', 'high wd'), col=c('black','red'), lty=c(1,2), bty = 'n', lwd=2, cex=2,)

curve(1/(1+((1/0.02)-1)*exp(-10*x)), ylim=c(0,1), xlim=c(0, 2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by wind fall')
curve(1/(1+((1/0.02)-1)*exp(-5*x)), ylim=c(0,1), xlim=c(0, 2), xaxt='n', ylab= 'Mortality rate', xlab='Size', main='Death by wind fall', add=T, col='red', lty=2, lwd=2)
axis(1, at=c(0,2), labels=c('Small', 'Large'))
legend(0.7,0.2, legend = c('low severity', 'high severity'), col=c('black','red'), lty=c(1,2), bty = 'n', lwd=2, cex=2,)
```



#Random notes

### MULTI-LEVEL NOTES:

####From Hedeker et al 2014

Nice summary of why multi-level models are essential for accounting for non-independence in nested datasets.

"An important question is then to determine the degree to which covariates are related to substance use initiation. In these studies it is often of interest to model the student outcomes while controlling for the nesting of students in classrooms and/or schools. In analysis of such grouped-time initiation (or survival) data, use of grouped-time regression models that assume independence of observations [Thompson, 1977; Prentice & Gloeckler, 1978; Allison, 1982] is therefore problematic because of this clustering of students. More generally, this same issue arises for other types of clustered datasets in which subjects are observed nested within various types of clusters (e.g., hospitals, firms, clinics, counties), and thus cannot be assumed to be independent. To account for the data clustering, multilevel models (also called hierarchical linear or mixed models) provide a useful approach for simultaneously estimating the parameters of the regression model and the variance components that account for the data clustering [Goldstein, 1995; Raudenbush & Bryk, 2002]."

## TWO REVIEW PAPERS TO READ Pickles et al 1995 & Hougaard 1995 ###

Lee et al 1992 has developed continuous0time survival models. However, the application of these models to grouped or discrete-time survival data is generally not recommended because of the large number of ties that result.

Instead, models specifically developed for grouped or discrete-time survival data have been proposed.

Both Han & Hausman (1990) and Scheike & Jensen (1997) have described proportional hazards models incorporating a log-gamma distribution specification of heterogeneity. Furthermore, Ten Have (1996) developed a discrete-time proportional hazards survival model incorporating a log-gamma random effects distribution, additionally allowing for ordinal survival and failure categories. Ten Have & Uttal (1994) used Gibbs samplng to fit a continuation ratio logit model with multiple normally distributed random effects.

## IMPORTANT NOTE ON link function

Doksum & Gasko (1990) note, that large amounts of high quality data are often necessary for link function selections to be relevant. McCullagh (1980) notes that the link function choice should be based primarily on ease of interpretation.

## Multilevel model that treats each individual's survival time as a set of dichotomous observations indicating whether or not an individual failed in each time unti until a person either experiences the event or is censored. This type of model is extensively described in Singer & Willett (2003) & is illustrated in Reardon et al (2002).

This approach is particularly useful for handling time-dependent covariates and fitting non-proportional hazards models because the covariate values can change across each individual's Tij timepoints.


# REFERENCES








