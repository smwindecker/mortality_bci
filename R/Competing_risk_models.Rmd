---
title: "Mortality models"
author: "J Camac"
output: html_document
---
```{r}
library('dplyr')
library('R2jags')
#Loads BCI data and attaches trait data
load('../data_BCI/output/bci.mainstem.Rdata')
bci.traits <- read.csv('../data_BCI/rawdata/traits/BCI_traits_20101220.csv')
names(bci.traits) <- tolower(names(bci.traits)) # lowers trait column names for merging
bci.traits$sp <- tolower(bci.traits$sp) # lowers species code names for merging
bci.mainstem <- merge(bci.mainstem,bci.traits[,c('sp','sg100c_avg')],by = 'sp') #only uses species trait data exists for.
rm(bci.traits) # trait db no longer needed

#Subsets data to only include species with traits and has a status record.
#Also removes couple of rows that have 10 yr census intervals.
#Then adds a sp.id column
bci.mainstem<- bci.mainstem %>%
  filter(!is.na(census.interval) & !is.na(sg100c_avg) & !is.na(dead.next.census) & census.interval< 6) %>%
  mutate(sp.id = as.numeric(factor(sp)))
bci.mainstem <- bci.mainstem[bci.mainstem$year==2005,]

  #Preps data for model by centering and scaling predictors and time
  data <- list(
  n_obs = nrow(bci.mainstem),
  n_spp = length(unique(bci.mainstem$sp)),
  spp = as.numeric(factor(bci.mainstem$sp), as.character(unique(bci.mainstem$sp))),
  wd =  scale(log(unique(bci.mainstem$sg100c_avg*1000)), 
              center = log(600), scale=2 *sd(log(unique(bci.mainstem$sg100c_avg*1000))))[,1],
  dbh = scale(bci.mainstem$dbh, center = FALSE, scale = 2 * sd(bci.mainstem$dbh))[,1],
  dbh_gr = scale(bci.mainstem$dbh.gr, center = FALSE, scale = 2 * sd(bci.mainstem$dbh.gr))[,1],
  dbh_rgr = scale(bci.mainstem$dbh.rgr,center = FALSE, scale = 2 * sd(bci.mainstem$dbh.rgr))[,1],
  basal_area = scale(bci.mainstem$basal.area, center = FALSE, scale = 2 * sd(bci.mainstem$basal.area))[,1],
  basal_gr = scale(bci.mainstem$basal.area.gr, center = FALSE, scale = 2 * sd(bci.mainstem$basal.area.gr))[,1],
  basal_rgr = scale(bci.mainstem$basal.area.rgr, center = FALSE, scale = 2 * sd(bci.mainstem$basal.area.rgr))[,1],
  census_length = bci.mainstem$census.interval,
  died = bci.mainstem$dead.next.census)

models <- c('basal_gr', 'basal_rgr')
nmodels <-length(models)
output <- list()
inits <- function() {
              list(    
              alpha0 = rlnorm(1,-3, 0.01),
              alpha1 = rlnorm(1,-3, 0.01),
              alpha2 = rlnorm(1,-3, 0.01),
              beta1 = rlnorm(1,-0.5, 0.01),
              beta2 = rlnorm(1,0, 0.01))
              }

for (i in 1:nmodels) {
  cat(sprintf('
              model {
              for(it in 1:n_obs) {
              died[it] ~ dbern(p[it])
              cloglog(p[it]) <- log(census_length[it]) + 
              log(alpha0 + alpha1 * exp(-beta1 * wd[spp[it]]) + alpha2 * exp(-beta2 * %s[it]))
              }
              
              #Priors
              alpha0 ~ dlnorm(0, 0.01) 
              alpha1 ~ dlnorm(0, 0.01) 
              alpha2 ~ dlnorm(0, 0.01)
              beta1 ~ dlnorm(0, 0.0001)
              beta2 ~ dlnorm(0, 0.0001)
              
              }',models[i]),file=(tmp <- tempfile()))
  
  system.time(output[[models[i]]] <- 
                      jags.parallel(
                        model.file = tmp,
                        n.iter = 30000,
                        data= names(data), 
                        envir=list2env(data),
                        inits = inits,
                        parameters.to.save = c('alpha0','alpha1','alpha2','beta1','beta2')))
  }
  beep('mario')
```